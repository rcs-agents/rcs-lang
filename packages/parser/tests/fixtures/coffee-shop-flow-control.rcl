flow TopFlow
  start: Welcome

  on Welcome
    match @reply.text
      "Start Order" -> start CreateOrder
        on :end -> append result to @orders -> ConfirmAllOrders
        on :cancel -> Welcome
        on :error -> OrderError
      "View Menu" -> ShowMenu
      :default -> Welcome

  on ConfirmAllOrders
    match @reply.text
      "Add Another Order" -> start CreateOrder
        on :end -> append result to @orders -> ConfirmAllOrders
        on :cancel -> ConfirmAllOrders
        on :error -> OrderError
      "Confirm All Orders" -> ProcessPayment
      "Cancel All Orders" -> set @orders to [] -> Welcome

  on ProcessPayment
    -> :end

  on OrderError
    match @reply.text
      "Try Again" -> Welcome
      "Cancel" -> :cancel

flow CreateOrder
  start: Menu

  on Menu
    match @reply.text
      "Order Coffee" -> start OrderCoffee
        on :end -> append result to @orderItems -> Menu
        on :cancel -> Menu
      "Confirm Order" -> ConfirmOrder
      "Cancel Order" -> :cancel

  on ConfirmOrder
    match @reply.text
      "Yes" -> :end
      "No" -> Menu
      "Cancel" -> :cancel

flow OrderCoffee
  start: ChooseDrink

  on ChooseDrink
    match @reply.text
      "Espresso" -> ChooseSize with drink: "espresso"
      "Latte" -> ChooseSize with drink: "latte"
      :default -> ChooseDrink

  on ChooseSize
    match @reply.text
      "Small" -> :end
      "Large" -> :end
      :default -> ChooseSize