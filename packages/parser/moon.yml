$schema: "https://moonrepo.dev/schemas/project.json"

project:
  name: '@rcs-lang/parser'
  description: 'ANTLR-based parser for RCL'

id: parser
type: library
language: typescript
platform: bun

dependsOn: []

tags:
  - test
  - common
  - typescript

tasks:
  prebuild:
    command: rm
    args: [-rf, src/generated]

  build-grammar:
    script: |
      bunx antlr-ng -D language=TypeScript \
        -o src/generated src/RclLexer.g4 && \
      bunx antlr-ng -D language=TypeScript --generate-visitor -o src/generated src/RclParser.g4

    deps:
      - prebuild
    inputs:
      - 'src/**/*.g4'
    outputs:
      - 'src/generated/*'

  compile:
    command: tsc
    deps:
      - build-grammar
    inputs:
      - 'src/**/*.g4'
      - 'src/**/*.ts'
      - 'tsconfig.json'
      - 'package.json'
    outputs:
      - 'dist'

  fix-esm-imports:
    command: bun
    args: [run, scripts/fix-esm-imports.ts]
    deps:
      - compile
    inputs:
      - 'dist/generated/*.js'
      - 'scripts/fix-esm-imports.ts'
    outputs:
      - 'dist/generated/*.js'

  build:
    deps:
      - fix-esm-imports

  test:
    command: bun
    args: [test]
    deps:
      - build
    inputs:
      - 'src/**/*'
      - 'tests/**/*'
