$schema: "https://moonrepo.dev/schemas/project.json"

project:
  name: '@rcs-lang/parser'
  description: 'ANTLR-based parser for RCL'

id: parser
type: library
language: typescript
platform: bun

dependsOn:
  - '@rcs-lang/ast'
  - '@rcs-lang/core'

tags:
  - test
  - common

tasks:
  prebuild:
    command: rm
    args: [-rf, src/generated]
    
  build-grammar:
    command: bash
    args: 
      - -c
      - "bunx antlr-ng -D language=TypeScript -o src/generated src/RclLexer.g4 && bunx antlr-ng -D language=TypeScript --generate-visitor -o src/generated src/RclParser.g4"
    deps:
      - prebuild
      
  fix-imports:
    command: bash
    args:
      - -c
      - |
        cd $MOON_WORKSPACE_ROOT/packages/parser/src/generated && \
        if [ -f RclLexer.ts ]; then \
          if ! grep -q "import { RclLexerBase }" RclLexer.ts; then \
            sed -i.bak '1s/^/import { RclLexerBase } from "..\/RclLexerBase.ts";\n/' RclLexer.ts; \
          fi && \
          for file in *.ts; do \
            if [ -f "$file" ]; then \
              sed -i.bak 's/from "\(\.\.[^"]*\)\([^.]\)"/from "\1\2.ts"/g' "$file"; \
            fi; \
          done && \
          rm -f *.ts.bak; \
        else \
          echo "No generated files found, skipping fix-imports"; \
        fi
    deps:
      - build-grammar

  build:
    command: tsc
    deps:
      - '@rcs-lang/ast:build'
      - '@rcs-lang/core:build'
      - fix-imports
    inputs:
      - 'src/**/*.g4'
      - 'src/**/*.ts'
      - 'tsconfig.json'
      - 'package.json'
    outputs:
      - 'dist'
      
  postbuild:
    command: bash
    args:
      - -c
      - |
        cd dist/generated && \
        sed -i.bak 's/from "\(\.\.[^"]*\)"/from "\1.js"/g' *.js && \
        rm -f *.js.bak
    deps:
      - build

  test:
    command: bun
    args: [test]
    deps:
      - build
    inputs:
      - 'src/**/*'
      - 'tests/**/*'